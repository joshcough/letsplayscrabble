// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Ordering from "../Data.Ordering/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Domain_Types from "../Domain.Types/index.js";
import * as Utils_Date from "../Utils.Date/index.js";
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordString);
var bind = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var pure = /* #__PURE__ */ Control_Applicative.pure(Data_Maybe.applicativeMaybe);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var eq1 = /* #__PURE__ */ Data_Eq.eq(Domain_Types.eqPlayerId);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var notEq = /* #__PURE__ */ Data_Eq.notEq(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqInt));
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var compare1 = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordInt);
var sortGames = /* #__PURE__ */ Data_Array.sortBy(function (a) {
    return function (b) {
        if (a.isCurrentTournament && !b.isCurrentTournament) {
            return Data_Ordering.LT.value;
        };
        if (!a.isCurrentTournament && b.isCurrentTournament) {
            return Data_Ordering.GT.value;
        };
        return compare(b.game.date)(a.game.date);
    };
});
var resolvePlayerIds = function (playerId1Param) {
    return function (playerId2Param) {
        return function (currentMatch) {
            return function (games) {
                if (currentMatch instanceof Data_Maybe.Just && (playerId1Param === 0 && playerId2Param === 0)) {
                    return bind(Data_Array.find(function (g) {
                        return Data_Maybe.maybe(false)(function (pid) {
                            return unwrap(pid) === currentMatch.value0.pairingId;
                        })(g.pairingId) && g.roundNumber === currentMatch.value0.round;
                    })(games))(function (game) {
                        return pure({
                            playerId1: unwrap(game.player1Id),
                            playerId2: unwrap(game.player2Id)
                        });
                    });
                };
                return new Data_Maybe.Just({
                    playerId1: playerId1Param,
                    playerId2: playerId2Param
                });
            };
        };
    };
};
var getPlaceOrSeedLabel = function (record) {
    var $29 = record.wins === 0 && record.losses === 0;
    if ($29) {
        return "Seed";
    };
    return "Place";
};
var findPlayerPair = function (playerId1) {
    return function (playerId2) {
        return function (players) {
            var maybePlayer2 = Data_Array.find(function (p) {
                return unwrap(p.id) === playerId2;
            })(players);
            var maybePlayer1 = Data_Array.find(function (p) {
                return unwrap(p.id) === playerId1;
            })(players);
            if (maybePlayer1 instanceof Data_Maybe.Just && maybePlayer2 instanceof Data_Maybe.Just) {
                return new Data_Maybe.Just({
                    player1: maybePlayer1.value0,
                    player2: maybePlayer2.value0
                });
            };
            return Data_Maybe.Nothing.value;
        };
    };
};
var resolveAndFindPlayers = function (playerId1Param) {
    return function (playerId2Param) {
        return function (currentMatch) {
            return function (division) {
                var v = resolvePlayerIds(playerId1Param)(playerId2Param)(currentMatch)(division.games);
                if (v instanceof Data_Maybe.Nothing) {
                    return Data_Maybe.Nothing.value;
                };
                if (v instanceof Data_Maybe.Just) {
                    return findPlayerPair(v.value0.playerId1)(v.value0.playerId2)(division.players);
                };
                throw new Error("Failed pattern match at Stats.HeadToHeadStats (line 234, column 3 - line 236, column 76): " + [ v.constructor.name ]);
            };
        };
    };
};
var convertGameToH2H = function (p1) {
    return function (p2) {
        return function (tournament) {
            return function (game) {
                var p2XtId = Data_Maybe.fromMaybe(0)(map(unwrap)(p2.xtid));
                var p1XtId = Data_Maybe.fromMaybe(0)(map(unwrap)(p1.xtid));
                var p1IsGamePlayer1 = eq1(game.player1Id)(p1.id);
                return {
                    gameid: game.id,
                    date: Utils_Date.todayISO,
                    tourneyname: new Data_Maybe.Just(tournament.name),
                    player1: {
                        playerid: p1XtId,
                        name: p1.name,
                        score: Data_Maybe.fromMaybe(0)((function () {
                            if (p1IsGamePlayer1) {
                                return game.player1Score;
                            };
                            return game.player2Score;
                        })()),
                        oldrating: 0,
                        newrating: 0,
                        position: Data_Maybe.Nothing.value
                    },
                    player2: {
                        playerid: p2XtId,
                        name: p2.name,
                        score: Data_Maybe.fromMaybe(0)((function () {
                            if (p1IsGamePlayer1) {
                                return game.player2Score;
                            };
                            return game.player1Score;
                        })()),
                        oldrating: 0,
                        newrating: 0,
                        position: Data_Maybe.Nothing.value
                    },
                    annotated: Data_Maybe.Nothing.value
                };
            };
        };
    };
};
var getHeadToHeadGames = function (p1) {
    return function (p2) {
        return function (division) {
            return function (tournament) {
                var p2XtId = Data_Maybe.fromMaybe(0)(map(unwrap)(p2.xtid));
                var p1XtId = Data_Maybe.fromMaybe(0)(map(unwrap)(p1.xtid));
                var historicalGames = Data_Array.filter(function (game) {
                    return game.player1.playerid === p1XtId && game.player2.playerid === p2XtId || game.player1.playerid === p2XtId && game.player2.playerid === p1XtId;
                })(division.headToHeadGames);
                var historicalH2H = map1(function (g) {
                    return {
                        game: g,
                        tournamentName: g.tourneyname,
                        isCurrentTournament: false
                    };
                })(historicalGames);
                var currentTournamentGames = Data_Array.filter(function (game) {
                    return (eq1(game.player1Id)(p1.id) && eq1(game.player2Id)(p2.id) || eq1(game.player1Id)(p2.id) && eq1(game.player2Id)(p1.id)) && (notEq(game.player1Score)(Data_Maybe.Nothing.value) && notEq(game.player2Score)(Data_Maybe.Nothing.value));
                })(division.games);
                var convertedCurrentGames = map1(convertGameToH2H(p1)(p2)(tournament))(currentTournamentGames);
                var currentH2H = map1(function (g) {
                    return {
                        game: g,
                        tournamentName: new Data_Maybe.Just(tournament.name),
                        isCurrentTournament: true
                    };
                })(convertedCurrentGames);
                return append(historicalH2H)(currentH2H);
            };
        };
    };
};
var comparePlayersByRecord = function (a) {
    return function (b) {
        return compare1(a.id)(b.id);
    };
};
var calculateRecord = function (playerId) {
    return function (division) {
        return Data_Array.foldl(function (acc) {
            return function (game) {
                if (game.player1Score instanceof Data_Maybe.Just && (game.player2Score instanceof Data_Maybe.Just && !game.isBye)) {
                    var $43 = eq1(game.player1Id)(playerId);
                    if ($43) {
                        var $44 = game.player1Score.value0 > game.player2Score.value0;
                        if ($44) {
                            return {
                                losses: acc.losses,
                                wins: acc.wins + 1 | 0,
                                spread: acc.spread + (game.player1Score.value0 - game.player2Score.value0 | 0) | 0
                            };
                        };
                        return {
                            wins: acc.wins,
                            losses: acc.losses + 1 | 0,
                            spread: acc.spread + (game.player1Score.value0 - game.player2Score.value0 | 0) | 0
                        };
                    };
                    var $45 = eq1(game.player2Id)(playerId);
                    if ($45) {
                        var $46 = game.player2Score.value0 > game.player1Score.value0;
                        if ($46) {
                            return {
                                losses: acc.losses,
                                wins: acc.wins + 1 | 0,
                                spread: acc.spread + (game.player2Score.value0 - game.player1Score.value0 | 0) | 0
                            };
                        };
                        return {
                            wins: acc.wins,
                            losses: acc.losses + 1 | 0,
                            spread: acc.spread + (game.player2Score.value0 - game.player1Score.value0 | 0) | 0
                        };
                    };
                    return acc;
                };
                return acc;
            };
        })({
            wins: 0,
            losses: 0,
            spread: 0
        })(division.games);
    };
};
var calculateH2HStats = function (p1) {
    return function (p2) {
        return function (h2hGames) {
            return function (division) {
                var sortedPlayers = Data_Array.sortBy(comparePlayersByRecord)(division.players);
                var player2Record = calculateRecord(p2.id)(division);
                var player2Position = Data_Maybe.fromMaybe(1)(Data_Array.findIndex(function (p) {
                    return eq1(p.id)(p2.id);
                })(sortedPlayers)) + 1 | 0;
                var player1Record = calculateRecord(p1.id)(division);
                var player1Position = Data_Maybe.fromMaybe(1)(Data_Array.findIndex(function (p) {
                    return eq1(p.id)(p1.id);
                })(sortedPlayers)) + 1 | 0;
                var p1XtId = Data_Maybe.fromMaybe(0)(map(function (v) {
                    return v;
                })(p1.xtid));
                var player1Wins = Data_Array.length(Data_Array.filter(function (gameExt) {
                    var p1Score = (function () {
                        var $50 = gameExt.game.player1.playerid === p1XtId;
                        if ($50) {
                            return gameExt.game.player1.score;
                        };
                        return gameExt.game.player2.score;
                    })();
                    var p2Score = (function () {
                        var $51 = gameExt.game.player1.playerid === p1XtId;
                        if ($51) {
                            return gameExt.game.player2.score;
                        };
                        return gameExt.game.player1.score;
                    })();
                    return p1Score > p2Score;
                })(h2hGames));
                var player2Wins = Data_Array.length(Data_Array.filter(function (gameExt) {
                    var p1Score = (function () {
                        var $52 = gameExt.game.player1.playerid === p1XtId;
                        if ($52) {
                            return gameExt.game.player1.score;
                        };
                        return gameExt.game.player2.score;
                    })();
                    var p2Score = (function () {
                        var $53 = gameExt.game.player1.playerid === p1XtId;
                        if ($53) {
                            return gameExt.game.player2.score;
                        };
                        return gameExt.game.player1.score;
                    })();
                    return p2Score > p1Score;
                })(h2hGames));
                var totals = Data_Array.foldl(function (acc) {
                    return function (gameExt) {
                        var p1Score = (function () {
                            var $54 = gameExt.game.player1.playerid === p1XtId;
                            if ($54) {
                                return gameExt.game.player1.score;
                            };
                            return gameExt.game.player2.score;
                        })();
                        var p2Score = (function () {
                            var $55 = gameExt.game.player1.playerid === p1XtId;
                            if ($55) {
                                return gameExt.game.player2.score;
                            };
                            return gameExt.game.player1.score;
                        })();
                        return {
                            p1Total: acc.p1Total + p1Score | 0,
                            p2Total: acc.p2Total + p2Score | 0,
                            count: acc.count + 1 | 0
                        };
                    };
                })({
                    p1Total: 0,
                    p2Total: 0,
                    count: 0
                })(h2hGames);
                var player1AvgScore = (function () {
                    var $56 = totals.count > 0;
                    if ($56) {
                        return Data_Int.toNumber(totals.p1Total) / Data_Int.toNumber(totals.count);
                    };
                    return 0.0;
                })();
                var player2AvgScore = (function () {
                    var $57 = totals.count > 0;
                    if ($57) {
                        return Data_Int.toNumber(totals.p2Total) / Data_Int.toNumber(totals.count);
                    };
                    return 0.0;
                })();
                return {
                    player1Wins: player1Wins,
                    player2Wins: player2Wins,
                    player1AvgScore: Data_Int.round(player1AvgScore),
                    player2AvgScore: Data_Int.round(player2AvgScore),
                    player1Record: player1Record,
                    player2Record: player2Record,
                    player1Position: player1Position,
                    player2Position: player2Position
                };
            };
        };
    };
};
export {
    getHeadToHeadGames,
    convertGameToH2H,
    calculateH2HStats,
    calculateRecord,
    sortGames,
    comparePlayersByRecord,
    getPlaceOrSeedLabel,
    resolvePlayerIds,
    findPlayerPair,
    resolveAndFindPlayers
};
