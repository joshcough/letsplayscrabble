// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Semiring from "../Data.Semiring/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Domain_Types from "../Domain.Types/index.js";
import * as Stats_PlayerStats from "../Stats.PlayerStats/index.js";
var eq1 = /* #__PURE__ */ Data_Eq.eq(Domain_Types.eqPlayerId);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var sum = /* #__PURE__ */ Data_Foldable.sum(Data_Foldable.foldableArray)(Data_Semiring.semiringInt);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var calculateStandingsPlayers = function (players) {
    return function (games) {
        return Stats_PlayerStats.calculateRankedStats(Stats_PlayerStats.Standings.value)(players)(games);
    };
};
var calculateScoringLeadersPlayers = function (players) {
    return function (games) {
        return Stats_PlayerStats.calculateRankedStats(Stats_PlayerStats.AverageScore.value)(players)(games);
    };
};
var calculateRatingGainPlayers = function (players) {
    return function (games) {
        return Stats_PlayerStats.calculateRankedStats(Stats_PlayerStats.RatingGain.value)(players)(games);
    };
};
var calculateHigherRatedWinPercent = function (games) {
    return function (players) {
        var $21 = Data_Array.length(players) === 0;
        if ($21) {
            return 0.0;
        };
        var getPlayerRatingBeforeRound = function (player) {
            return function (roundNumber) {
                var $22 = roundNumber === 1;
                if ($22) {
                    return player.initialRating;
                };
                var ratingIndex = roundNumber - 2 | 0;
                return Data_Maybe.fromMaybe(player.initialRating)(Data_Array.index(player.ratingsHistory)(ratingIndex));
            };
        };
        var findPlayer = function (playerId) {
            var v = Data_Array.filter(function (p) {
                return eq1(p.id)(playerId);
            })(players);
            if (v.length === 1) {
                return new Data_Maybe.Just(v[0]);
            };
            return Data_Maybe.Nothing.value;
        };
        var gamesWithRatings = Data_Array.filter(function (game) {
            var v = findPlayer(game.player2Id);
            var v1 = findPlayer(game.player1Id);
            if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                return true;
            };
            return false;
        })(games);
        var gamesCount = Data_Array.length(gamesWithRatings);
        var higherRatedWins = Data_Array.length(Data_Array.filter(function (game) {
            var v = findPlayer(game.player2Id);
            var v1 = findPlayer(game.player1Id);
            if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                var p2Rating = getPlayerRatingBeforeRound(v.value0)(game.roundNumber);
                var p1Won = Data_Maybe.fromMaybe(0)(game.player1Score) > Data_Maybe.fromMaybe(0)(game.player2Score);
                var p1Rating = getPlayerRatingBeforeRound(v1.value0)(game.roundNumber);
                var p1Higher = p1Rating > p2Rating;
                return p1Higher && p1Won || !p1Higher && !p1Won;
            };
            return false;
        })(gamesWithRatings));
        var $33 = gamesCount > 0;
        if ($33) {
            return (Data_Int.toNumber(higherRatedWins) / Data_Int.toNumber(gamesCount)) * 100.0;
        };
        return 0.0;
    };
};
var calculateTournamentStats = function (games) {
    return function (players) {
        var totalPlayers = Data_Array.length(players);
        var completedGames = Data_Array.filter(function (game) {
            if (game.player1Score instanceof Data_Maybe.Just && game.player2Score instanceof Data_Maybe.Just) {
                return !game.isBye;
            };
            return false;
        })(games);
        var gamesPlayed = Data_Array.length(completedGames);
        var goingFirstWins = Data_Array.length(Data_Array.filter(function (game) {
            return Data_Maybe.fromMaybe(0)(game.player1Score) > Data_Maybe.fromMaybe(0)(game.player2Score);
        })(completedGames));
        var goingFirstWinPercent = (function () {
            var $38 = gamesPlayed > 0;
            if ($38) {
                return (Data_Int.toNumber(goingFirstWins) / Data_Int.toNumber(gamesPlayed)) * 100.0;
            };
            return 0.0;
        })();
        var higherRatedWinPercent = calculateHigherRatedWinPercent(completedGames)(players);
        var scores = foldl(function (acc) {
            return function (game) {
                if (game.player1Score instanceof Data_Maybe.Just && game.player2Score instanceof Data_Maybe.Just) {
                    var $41 = game.player1Score.value0 > game.player2Score.value0;
                    if ($41) {
                        return {
                            winning: append(acc.winning)([ game.player1Score.value0 ]),
                            losing: append(acc.losing)([ game.player2Score.value0 ])
                        };
                    };
                    var $42 = game.player2Score.value0 > game.player1Score.value0;
                    if ($42) {
                        return {
                            winning: append(acc.winning)([ game.player2Score.value0 ]),
                            losing: append(acc.losing)([ game.player1Score.value0 ])
                        };
                    };
                    return acc;
                };
                return acc;
            };
        })({
            winning: [  ],
            losing: [  ]
        })(completedGames);
        var totalPoints = foldl(function (acc) {
            return function (game) {
                return (acc + Data_Maybe.fromMaybe(0)(game.player1Score) | 0) + Data_Maybe.fromMaybe(0)(game.player2Score) | 0;
            };
        })(0)(completedGames);
        var avgWinning = (function () {
            var $45 = Data_Array.length(scores.winning) > 0;
            if ($45) {
                return Data_Int.round(Data_Int.toNumber(sum(scores.winning)) / Data_Int.toNumber(Data_Array.length(scores.winning)));
            };
            return 0;
        })();
        var avgLosing = (function () {
            var $46 = Data_Array.length(scores.losing) > 0;
            if ($46) {
                return Data_Int.round(Data_Int.toNumber(sum(scores.losing)) / Data_Int.toNumber(Data_Array.length(scores.losing)));
            };
            return 0;
        })();
        var averageScore = show(avgWinning) + ("-" + show(avgLosing));
        return {
            gamesPlayed: gamesPlayed,
            pointsScored: totalPoints,
            averageScore: averageScore,
            higherRatedWinPercent: higherRatedWinPercent,
            goingFirstWinPercent: goingFirstWinPercent,
            totalPlayers: totalPlayers
        };
    };
};
var calculateHighScorePlayers = function (players) {
    return function (games) {
        return Stats_PlayerStats.calculateRankedStats(Stats_PlayerStats.HighScore.value)(players)(games);
    };
};
var calculateAllTournamentStats = function (tournament) {
    var allPlayers = foldl(function (acc) {
        return function (div1) {
            return append(acc)(div1.players);
        };
    })([  ])(tournament.divisions);
    var allGames = foldl(function (acc) {
        return function (div1) {
            return append(acc)(div1.games);
        };
    })([  ])(tournament.divisions);
    return calculateTournamentStats(allGames)(allPlayers);
};
export {
    calculateTournamentStats,
    calculateHigherRatedWinPercent,
    calculateAllTournamentStats,
    calculateRatingGainPlayers,
    calculateHighScorePlayers,
    calculateScoringLeadersPlayers,
    calculateStandingsPlayers
};
