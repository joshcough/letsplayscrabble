// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Argonaut_Core from "../Data.Argonaut.Core/index.js";
import * as Data_Argonaut_Decode_Class from "../Data.Argonaut.Decode.Class/index.js";
import * as Data_Argonaut_Encode_Class from "../Data.Argonaut.Encode.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Halogen_Subscription from "../Halogen.Subscription/index.js";
import * as PubSub_Class from "../PubSub.Class/index.js";
import * as PubSub_InMemory from "../PubSub.InMemory/index.js";
import * as Test_Spec from "../Test.Spec/index.js";
import * as Test_Spec_Assertions from "../Test.Spec.Assertions/index.js";
import * as Types_CurrentMatch from "../Types.CurrentMatch/index.js";
var bind = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var subscribe = /* #__PURE__ */ PubSub_Class.subscribe(PubSub_InMemory.pubSubInMemoryChannel);
var decodeJson = /* #__PURE__ */ Data_Argonaut_Decode_Class.decodeJson(Types_CurrentMatch.decodeJsonCurrentMatch);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var postMessage = /* #__PURE__ */ PubSub_Class.postMessage(PubSub_InMemory.pubSubInMemoryChannel);
var encodeJson = /* #__PURE__ */ Data_Argonaut_Encode_Class.encodeJson(Types_CurrentMatch.encodeJsonCurrentMatch);
var shouldEqual = /* #__PURE__ */ Test_Spec_Assertions.shouldEqual(Effect_Aff.monadThrowAff);
var shouldEqual1 = /* #__PURE__ */ shouldEqual(/* #__PURE__ */ Data_Show.showArray(Types_CurrentMatch.showCurrentMatch))(/* #__PURE__ */ Data_Eq.eqArray(Types_CurrentMatch.eqCurrentMatch));
var shouldEqual2 = /* #__PURE__ */ shouldEqual(Data_Show.showInt)(Data_Eq.eqInt);
var shouldEqual3 = /* #__PURE__ */ shouldEqual(/* #__PURE__ */ Data_Maybe.showMaybe(Data_Show.showString))(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqString));
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var shouldEqual4 = /* #__PURE__ */ shouldEqual(/* #__PURE__ */ Data_Maybe.showMaybe(Types_CurrentMatch.showCurrentMatch))(/* #__PURE__ */ Data_Maybe.eqMaybe(Types_CurrentMatch.eqCurrentMatch));
var describe = /* #__PURE__ */ Test_Spec.describe(Data_Identity.monadIdentity);
var discard2 = /* #__PURE__ */ discard(/* #__PURE__ */ Test_Spec.bindSpecT(Data_Identity.bindIdentity));
var it = /* #__PURE__ */ Test_Spec.it(Data_Identity.monadIdentity)(Test_Spec.exampleMUnit);
var testTypedMessages = /* #__PURE__ */ bind(/* #__PURE__ */ liftEffect(/* #__PURE__ */ PubSub_InMemory.testChannel("typed-test")))(function (channel) {
    return bind(liftEffect(Effect_Ref["new"]([  ])))(function (received) {
        return bind(liftEffect(subscribe(channel)))(function (emitter) {
            return bind(liftEffect(Halogen_Subscription.subscribe(emitter)(function (json) {
                var v = decodeJson(json);
                if (v instanceof Data_Either.Right) {
                    return Effect_Ref.modify_(function (v1) {
                        return append(v1)([ v.value0 ]);
                    })(received);
                };
                if (v instanceof Data_Either.Left) {
                    return pure(Data_Unit.unit);
                };
                throw new Error("Failed pattern match at Test.PubSub.IntegrationSpec (line 105, column 5 - line 109, column 18): " + [ v.constructor.name ]);
            })))(function () {
                var original = {
                    tournamentId: 123,
                    divisionId: 456,
                    divisionName: "Test Division",
                    round: 5,
                    pairingId: Data_Maybe.Nothing.value,
                    updatedAt: "2025-12-01T10:00:00Z"
                };
                return discard1(liftEffect(postMessage(channel)(encodeJson(original))))(function () {
                    return discard1(Effect_Aff.delay(10.0))(function () {
                        return bind(liftEffect(Effect_Ref.read(received)))(function (messages) {
                            return shouldEqual1(messages)([ original ]);
                        });
                    });
                });
            });
        });
    });
});
var testMultipleSubscribers = /* #__PURE__ */ bind(/* #__PURE__ */ liftEffect(/* #__PURE__ */ PubSub_InMemory.testChannel("multi-test")))(function (channel) {
    return bind(liftEffect(Effect_Ref["new"]([  ])))(function (received1) {
        return bind(liftEffect(Effect_Ref["new"]([  ])))(function (received2) {
            return bind(liftEffect(subscribe(channel)))(function (emitter) {
                return bind(liftEffect(Halogen_Subscription.subscribe(emitter)(function (msg) {
                    return Effect_Ref.modify_(function (v) {
                        return append(v)([ msg ]);
                    })(received1);
                })))(function () {
                    return bind(liftEffect(Halogen_Subscription.subscribe(emitter)(function (msg) {
                        return Effect_Ref.modify_(function (v) {
                            return append(v)([ msg ]);
                        })(received2);
                    })))(function () {
                        var testMessage = Data_Argonaut_Core.fromString("Broadcast!");
                        return discard1(liftEffect(postMessage(channel)(testMessage)))(function () {
                            return discard1(Effect_Aff.delay(10.0))(function () {
                                return bind(liftEffect(Effect_Ref.read(received1)))(function (messages1) {
                                    return bind(liftEffect(Effect_Ref.read(received2)))(function (messages2) {
                                        return discard1(shouldEqual2(Data_Array.length(messages1))(1))(function () {
                                            return discard1(shouldEqual3(map(Data_Argonaut_Core.stringify)(Data_Array.index(messages1)(0)))(new Data_Maybe.Just(Data_Argonaut_Core.stringify(testMessage))))(function () {
                                                return discard1(shouldEqual2(Data_Array.length(messages2))(1))(function () {
                                                    return shouldEqual3(map(Data_Argonaut_Core.stringify)(Data_Array.index(messages2)(0)))(new Data_Maybe.Just(Data_Argonaut_Core.stringify(testMessage)));
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
var testMessageDelivery = /* #__PURE__ */ bind(/* #__PURE__ */ liftEffect(/* #__PURE__ */ PubSub_InMemory.testChannel("test-channel")))(function (channel) {
    return bind(liftEffect(Effect_Ref["new"]([  ])))(function (received) {
        return bind(liftEffect(subscribe(channel)))(function (emitter) {
            return bind(liftEffect(Halogen_Subscription.subscribe(emitter)(function (msg) {
                return Effect_Ref.modify_(function (v) {
                    return append(v)([ msg ]);
                })(received);
            })))(function () {
                var testMessage = Data_Argonaut_Core.fromString("Hello, World!");
                return discard1(liftEffect(postMessage(channel)(testMessage)))(function () {
                    return discard1(Effect_Aff.delay(10.0))(function () {
                        return bind(liftEffect(Effect_Ref.read(received)))(function (messages) {
                            return discard1(shouldEqual2(Data_Array.length(messages))(1))(function () {
                                return shouldEqual3(map(Data_Argonaut_Core.stringify)(Data_Array.index(messages)(0)))(new Data_Maybe.Just(Data_Argonaut_Core.stringify(testMessage)));
                            });
                        });
                    });
                });
            });
        });
    });
});
var testComponentIntegration = function (dictPubSub) {
    var subscribe1 = PubSub_Class.subscribe(dictPubSub);
    var postMessage1 = PubSub_Class.postMessage(dictPubSub);
    return function (channel) {
        return bind(liftEffect(Effect_Ref["new"](Data_Maybe.Nothing.value)))(function (received) {
            return bind(liftEffect(subscribe1(channel)))(function (emitter) {
                return bind(liftEffect(Halogen_Subscription.subscribe(emitter)(function (json) {
                    var v = decodeJson(json);
                    if (v instanceof Data_Either.Right) {
                        return Effect_Ref.write(new Data_Maybe.Just(v.value0))(received);
                    };
                    if (v instanceof Data_Either.Left) {
                        return pure(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at Test.PubSub.IntegrationSpec (line 139, column 5 - line 143, column 18): " + [ v.constructor.name ]);
                })))(function () {
                    var gameUpdate = {
                        tournamentId: 100,
                        divisionId: 200,
                        divisionName: "Division A",
                        round: 3,
                        pairingId: Data_Maybe.Nothing.value,
                        updatedAt: "2025-12-01T15:00:00Z"
                    };
                    return discard1(liftEffect(postMessage1(channel)(encodeJson(gameUpdate))))(function () {
                        return discard1(Effect_Aff.delay(10.0))(function () {
                            return bind(liftEffect(Effect_Ref.read(received)))(function (result) {
                                return shouldEqual4(result)(new Data_Maybe.Just(gameUpdate));
                            });
                        });
                    });
                });
            });
        });
    };
};
var spec = /* #__PURE__ */ describe("PubSub Integration Tests")(/* #__PURE__ */ describe("InMemory PubSub")(/* #__PURE__ */ discard2(/* #__PURE__ */ it("delivers messages to subscribers")(testMessageDelivery))(function () {
    return discard2(it("handles multiple subscribers")(testMultipleSubscribers))(function () {
        return it("delivers typed messages correctly")(testTypedMessages);
    });
})));
export {
    spec,
    testMessageDelivery,
    testMultipleSubscribers,
    testTypedMessages,
    testComponentIntegration
};
