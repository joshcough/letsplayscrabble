// Generated by purs version 0.15.15
import * as Api_CurrentMatchApi from "../Api.CurrentMatchApi/index.js";
import * as Api_TournamentApi from "../Api.TournamentApi/index.js";
import * as BroadcastChannel_Manager from "../BroadcastChannel.Manager/index.js";
import * as Component_WorkerPageHelpers from "../Component.WorkerPageHelpers/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Rec_Class from "../Control.Monad.Rec.Class/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Domain_Types from "../Domain.Types/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Halogen_Component from "../Halogen.Component/index.js";
import * as Halogen_HTML_Core from "../Halogen.HTML.Core/index.js";
import * as Halogen_HTML_Elements from "../Halogen.HTML.Elements/index.js";
import * as Halogen_HTML_Properties from "../Halogen.HTML.Properties/index.js";
import * as Halogen_Query_HalogenM from "../Halogen.Query.HalogenM/index.js";
import * as Halogen_Subscription from "../Halogen.Subscription/index.js";
import * as Utils_Logger from "../Utils.Logger/index.js";
import * as Worker_WorkerSocketManager from "../Worker.WorkerSocketManager/index.js";
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var bind = /* #__PURE__ */ Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM);
var $$void = /* #__PURE__ */ Data_Functor["void"](Halogen_Query_HalogenM.functorHalogenM);
var mapFlipped = /* #__PURE__ */ Data_Functor.mapFlipped(Halogen_Subscription.functorEmitter);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(Halogen_Query_HalogenM.monadStateHalogenM);
var voidRight = /* #__PURE__ */ Data_Functor.voidRight(Halogen_Subscription.functorEmitter);
var forever = /* #__PURE__ */ Control_Monad_Rec_Class.forever(Halogen_Query_HalogenM.monadRecHalogenM);
var get = /* #__PURE__ */ Control_Monad_State_Class.get(Halogen_Query_HalogenM.monadStateHalogenM);
var pure = /* #__PURE__ */ Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var when = /* #__PURE__ */ Control_Applicative.when(Halogen_Query_HalogenM.applicativeHalogenM);
var eqRec = /* #__PURE__ */ Data_Eq.eqRec();
var eqRowCons = /* #__PURE__ */ Data_Eq.eqRowCons(Data_Eq.eqRowNil)();
var nameIsSymbol = {
    reflectSymbol: function () {
        return "name";
    }
};
var idIsSymbol = {
    reflectSymbol: function () {
        return "id";
    }
};
var eqMaybe = /* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqInt);
var eqMaybe1 = /* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqString);
var dateIsSymbol = {
    reflectSymbol: function () {
        return "date";
    }
};
var playeridIsSymbol = {
    reflectSymbol: function () {
        return "playerid";
    }
};
var cityIsSymbol = {
    reflectSymbol: function () {
        return "city";
    }
};
var eqRec1 = /* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "score";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "position";
    }
})(eqMaybe))()(playeridIsSymbol)(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "oldrating";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "newrating";
    }
})(Data_Eq.eqInt))()(nameIsSymbol)(Data_Eq.eqString));
var eq = /* #__PURE__ */ Data_Eq.eq(/* #__PURE__ */ Data_Maybe.eqMaybe(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "year";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "transparentBackground";
    }
})(Data_Eq.eqBoolean))()({
    reflectSymbol: function () {
        return "theme";
    }
})(Data_Eq.eqString))()(nameIsSymbol)(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "longFormName";
    }
})(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "lexicon";
    }
})(Data_Eq.eqString))()(idIsSymbol)(Domain_Types.eqTournamentId))()({
    reflectSymbol: function () {
        return "divisions";
    }
})(/* #__PURE__ */ Data_Eq.eqArray(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "players";
    }
})(/* #__PURE__ */ Data_Eq.eqArray(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "xtid";
    }
})(/* #__PURE__ */ Data_Maybe.eqMaybe(Domain_Types.eqXTId)))()({
    reflectSymbol: function () {
        return "xtData";
    }
})(/* #__PURE__ */ Data_Maybe.eqMaybe(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "w";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "twlrating";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "twlranking";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "tournamentCount";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "t";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "state";
    }
})(eqMaybe1))()({
    reflectSymbol: function () {
        return "results";
    }
})(/* #__PURE__ */ Data_Maybe.eqMaybe(/* #__PURE__ */ Data_Eq.eqArray(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "wins";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "tourneyid";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "totalplayers";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "ties";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "ratingchange";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "rating";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "points";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "place";
    }
})(Data_Eq.eqInt))()(nameIsSymbol)(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "losses";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "division";
    }
})(Data_Eq.eqString))()(dateIsSymbol)(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "averagepoints";
    }
})(Data_Eq.eqInt))))))()(playeridIsSymbol)(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "photourl";
    }
})(eqMaybe1))()({
    reflectSymbol: function () {
        return "opponentAverageScore";
    }
})(eqMaybe))()(nameIsSymbol)(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "l";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "cswrating";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "cswranking";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "country";
    }
})(eqMaybe1))()(cityIsSymbol)(eqMaybe1))()({
    reflectSymbol: function () {
        return "b";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "averageScore";
    }
})(eqMaybe)))))()({
    reflectSymbol: function () {
        return "seed";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "ratingsHistory";
    }
})(/* #__PURE__ */ Data_Eq.eqArray(Data_Eq.eqInt)))()({
    reflectSymbol: function () {
        return "photo";
    }
})(eqMaybe1))()(nameIsSymbol)(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "initialRating";
    }
})(Data_Eq.eqInt))()(idIsSymbol)(Domain_Types.eqPlayerId)))))()(nameIsSymbol)(Data_Eq.eqString))()(idIsSymbol)(Domain_Types.eqDivisionId))()({
    reflectSymbol: function () {
        return "headToHeadGames";
    }
})(/* #__PURE__ */ Data_Eq.eqArray(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "tourneyname";
    }
})(eqMaybe1))()({
    reflectSymbol: function () {
        return "player2";
    }
})(eqRec1))()({
    reflectSymbol: function () {
        return "player1";
    }
})(eqRec1))()({
    reflectSymbol: function () {
        return "gameid";
    }
})(Data_Eq.eqInt))()(dateIsSymbol)(Data_Eq.eqString))()({
    reflectSymbol: function () {
        return "annotated";
    }
})(eqMaybe1)))))()({
    reflectSymbol: function () {
        return "games";
    }
})(/* #__PURE__ */ Data_Eq.eqArray(/* #__PURE__ */ eqRec(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ Data_Eq.eqRowCons(/* #__PURE__ */ eqRowCons({
    reflectSymbol: function () {
        return "roundNumber";
    }
})(Data_Eq.eqInt))()({
    reflectSymbol: function () {
        return "player2Score";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "player2Id";
    }
})(Domain_Types.eqPlayerId))()({
    reflectSymbol: function () {
        return "player1Score";
    }
})(eqMaybe))()({
    reflectSymbol: function () {
        return "player1Id";
    }
})(Domain_Types.eqPlayerId))()({
    reflectSymbol: function () {
        return "pairingId";
    }
})(/* #__PURE__ */ Data_Maybe.eqMaybe(Domain_Types.eqPairingId)))()({
    reflectSymbol: function () {
        return "isBye";
    }
})(Data_Eq.eqBoolean))()(idIsSymbol)(Domain_Types.eqGameId))))))))()({
    reflectSymbol: function () {
        return "dataUrl";
    }
})(Data_Eq.eqString))()(cityIsSymbol)(Data_Eq.eqString))));
var insert = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var postAdminPanelUpdate = /* #__PURE__ */ BroadcastChannel_Manager.postAdminPanelUpdate(Effect_Class.monadEffectEffect);
var postTournamentDataResponse = /* #__PURE__ */ BroadcastChannel_Manager.postTournamentDataResponse(Effect_Class.monadEffectEffect);
var mapFlipped1 = /* #__PURE__ */ Data_Functor.mapFlipped(Data_Maybe.functorMaybe);
var Initialize = /* #__PURE__ */ (function () {
    function Initialize() {

    };
    Initialize.value = new Initialize();
    return Initialize;
})();
var Finalize = /* #__PURE__ */ (function () {
    function Finalize() {

    };
    Finalize.value = new Finalize();
    return Finalize;
})();
var UpdateStatus = /* #__PURE__ */ (function () {
    function UpdateStatus() {

    };
    UpdateStatus.value = new UpdateStatus();
    return UpdateStatus;
})();
var HandleSubscribe = /* #__PURE__ */ (function () {
    function HandleSubscribe(value0) {
        this.value0 = value0;
    };
    HandleSubscribe.create = function (value0) {
        return new HandleSubscribe(value0);
    };
    return HandleSubscribe;
})();
var makeCacheKey = function (userId) {
    return function (v) {
        return show(userId) + (":" + show(v));
    };
};
var initialState = function (v) {
    return {
        workerState: Data_Maybe.Nothing.value,
        broadcastManager: Data_Maybe.Nothing.value,
        emitterManager: Data_Maybe.Nothing.value,
        status: "Initializing...",
        error: Data_Maybe.Nothing.value,
        lastUpdate: 0.0,
        cache: Data_Map_Internal.empty
    };
};
var handleAction = function (dictMonadAff) {
    var monadEffectHalogenM = Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0());
    var liftEffect = Effect_Class.liftEffect(monadEffectHalogenM);
    var liftAff = Effect_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff));
    var postTournamentDataResponse1 = BroadcastChannel_Manager.postTournamentDataResponse(monadEffectHalogenM);
    return function (v) {
        if (v instanceof Initialize) {
            return bind(liftEffect(BroadcastChannel_Manager.create))(function (v1) {
                return discard($$void(Halogen_Query_HalogenM.subscribe(mapFlipped(v1.emitterManager.subscribeEmitter)(HandleSubscribe.create))))(function () {
                    return discard(modify_(function (v2) {
                        var $412 = {};
                        for (var $413 in v2) {
                            if ({}.hasOwnProperty.call(v2, $413)) {
                                $412[$413] = v2[$413];
                            };
                        };
                        $412.broadcastManager = new Data_Maybe.Just(v1.broadcastManager);
                        $412.emitterManager = new Data_Maybe.Just(v1.emitterManager);
                        return $412;
                    }))(function () {
                        return bind(liftEffect(function __do() {
                            var workerState = Worker_WorkerSocketManager.createWorkerState();
                            return Effect_Ref["new"](workerState)();
                        }))(function (stateRef) {
                            return discard(liftEffect(Worker_WorkerSocketManager.initialize("http://localhost:3001")(stateRef)))(function () {
                                return discard(modify_(function (v2) {
                                    var $415 = {};
                                    for (var $416 in v2) {
                                        if ({}.hasOwnProperty.call(v2, $416)) {
                                            $415[$416] = v2[$416];
                                        };
                                    };
                                    $415.workerState = new Data_Maybe.Just(stateRef);
                                    return $415;
                                }))(function () {
                                    return bind(liftEffect(Halogen_Subscription.create))(function (v2) {
                                        return bind(Halogen_Query_HalogenM.subscribe(voidRight(UpdateStatus.value)(v2.emitter)))(function () {
                                            return $$void(Halogen_Query_HalogenM.fork(forever(discard(liftAff(Effect_Aff.delay(500.0)))(function () {
                                                return liftEffect(Halogen_Subscription.notify(v2.listener)(Data_Unit.unit));
                                            }))));
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        };
        if (v instanceof Finalize) {
            return bind(get)(function (state) {
                if (state.workerState instanceof Data_Maybe.Just) {
                    return liftEffect(Worker_WorkerSocketManager.cleanup(state.workerState.value0));
                };
                if (state.workerState instanceof Data_Maybe.Nothing) {
                    return pure(Data_Unit.unit);
                };
                throw new Error("Failed pattern match at Component.WorkerPage (line 141, column 5 - line 143, column 27): " + [ state.workerState.constructor.name ]);
            });
        };
        if (v instanceof UpdateStatus) {
            return bind(get)(function (state) {
                if (state.workerState instanceof Data_Maybe.Just) {
                    return bind(liftEffect(Effect_Ref.read(state.workerState.value0)))(function (workerState) {
                        return modify_(function (v1) {
                            var $426 = {};
                            for (var $427 in v1) {
                                if ({}.hasOwnProperty.call(v1, $427)) {
                                    $426[$427] = v1[$427];
                                };
                            };
                            $426.status = workerState.connectionStatus;
                            $426.error = workerState.error;
                            $426.lastUpdate = workerState.lastDataUpdate;
                            return $426;
                        });
                    });
                };
                if (state.workerState instanceof Data_Maybe.Nothing) {
                    return pure(Data_Unit.unit);
                };
                throw new Error("Failed pattern match at Component.WorkerPage (line 148, column 5 - line 156, column 27): " + [ state.workerState.constructor.name ]);
            });
        };
        if (v instanceof HandleSubscribe) {
            if (v.value0.tournament instanceof Data_Maybe.Nothing) {
                return bind(liftAff(Api_CurrentMatchApi.fetchCurrentMatch(v.value0.userId)))(function (currentMatchResult) {
                    if (currentMatchResult instanceof Data_Either.Left) {
                        return discard(liftEffect(Utils_Logger.log("[WorkerPage] Error fetching current match: " + currentMatchResult.value0)))(function () {
                            return pure(Data_Unit.unit);
                        });
                    };
                    if (currentMatchResult instanceof Data_Either.Right && currentMatchResult.value0 instanceof Data_Maybe.Nothing) {
                        return pure(Data_Unit.unit);
                    };
                    if (currentMatchResult instanceof Data_Either.Right && currentMatchResult.value0 instanceof Data_Maybe.Just) {
                        var cm = unwrap(currentMatchResult.value0.value0);
                        var cacheKey = makeCacheKey(v.value0.userId)(cm.tournamentId);
                        return bind(get)(function (state) {
                            var cachedTournament = lookup(cacheKey)(state.cache);
                            return bind((function () {
                                if (cachedTournament instanceof Data_Maybe.Just) {
                                    return pure(new Data_Either.Right(cachedTournament.value0));
                                };
                                if (cachedTournament instanceof Data_Maybe.Nothing) {
                                    return liftAff(Api_TournamentApi.fetchTournamentData(v.value0.userId)(cm.tournamentId)(Data_Maybe.Nothing.value));
                                };
                                throw new Error("Failed pattern match at Component.WorkerPage (line 181, column 31 - line 188, column 26): " + [ cachedTournament.constructor.name ]);
                            })())(function (tournamentData) {
                                if (tournamentData instanceof Data_Either.Left) {
                                    return discard(liftEffect(Utils_Logger.log("[WorkerPage] Error fetching tournament data: " + tournamentData.value0)))(function () {
                                        return pure(Data_Unit.unit);
                                    });
                                };
                                if (tournamentData instanceof Data_Either.Right) {
                                    return discard(when(eq(cachedTournament)(Data_Maybe.Nothing.value))(modify_(function (v1) {
                                        var $438 = {};
                                        for (var $439 in v1) {
                                            if ({}.hasOwnProperty.call(v1, $439)) {
                                                $438[$439] = v1[$439];
                                            };
                                        };
                                        $438.cache = insert(cacheKey)(tournamentData.value0)(state.cache);
                                        return $438;
                                    })))(function () {
                                        return bind(get)(function (freshState) {
                                            if (freshState.broadcastManager instanceof Data_Maybe.Just) {
                                                return discard((function () {
                                                    if (cm.pairingId instanceof Data_Maybe.Just) {
                                                        var adminUpdate = {
                                                            userId: v.value0.userId,
                                                            tournamentId: cm.tournamentId,
                                                            divisionId: cm.divisionId,
                                                            divisionName: cm.divisionName,
                                                            round: cm.round,
                                                            pairingId: cm.pairingId.value0
                                                        };
                                                        return liftEffect(postAdminPanelUpdate(freshState.broadcastManager.value0)(adminUpdate));
                                                    };
                                                    if (cm.pairingId instanceof Data_Maybe.Nothing) {
                                                        return pure(Data_Unit.unit);
                                                    };
                                                    throw new Error("Failed pattern match at Component.WorkerPage (line 205, column 21 - line 217, column 34): " + [ cm.pairingId.constructor.name ]);
                                                })())(function () {
                                                    var response = {
                                                        userId: v.value0.userId,
                                                        tournamentId: cm.tournamentId,
                                                        isCurrentMatch: true,
                                                        data: tournamentData.value0
                                                    };
                                                    return liftEffect(postTournamentDataResponse(freshState.broadcastManager.value0)(response));
                                                });
                                            };
                                            if (freshState.broadcastManager instanceof Data_Maybe.Nothing) {
                                                return liftEffect(Utils_Logger.log("[WorkerPage] ERROR: No broadcast manager"));
                                            };
                                            throw new Error("Failed pattern match at Component.WorkerPage (line 202, column 17 - line 227, column 89): " + [ freshState.broadcastManager.constructor.name ]);
                                        });
                                    });
                                };
                                throw new Error("Failed pattern match at Component.WorkerPage (line 190, column 13 - line 227, column 89): " + [ tournamentData.constructor.name ]);
                            });
                        });
                    };
                    throw new Error("Failed pattern match at Component.WorkerPage (line 165, column 9 - line 227, column 89): " + [ currentMatchResult.constructor.name ]);
                });
            };
            if (v.value0.tournament instanceof Data_Maybe.Just) {
                var cacheKey = makeCacheKey(v.value0.userId)(v.value0.tournament.value0.tournamentId);
                return bind(get)(function (state) {
                    var cachedTournament = lookup(cacheKey)(state.cache);
                    return bind((function () {
                        if (cachedTournament instanceof Data_Maybe.Just) {
                            return pure(new Data_Either.Right(cachedTournament.value0));
                        };
                        if (cachedTournament instanceof Data_Maybe.Nothing) {
                            return liftAff(Api_TournamentApi.fetchTournamentData(v.value0.userId)(v.value0.tournament.value0.tournamentId)(Data_Maybe.Nothing.value));
                        };
                        throw new Error("Failed pattern match at Component.WorkerPage (line 237, column 27 - line 242, column 90): " + [ cachedTournament.constructor.name ]);
                    })())(function (tournamentData) {
                        if (tournamentData instanceof Data_Either.Left) {
                            return discard(liftEffect(Utils_Logger.log("[WorkerPage] API fetch failed: " + tournamentData.value0)))(function () {
                                return pure(Data_Unit.unit);
                            });
                        };
                        if (tournamentData instanceof Data_Either.Right) {
                            return discard(when(eq(cachedTournament)(Data_Maybe.Nothing.value))(modify_(function (v1) {
                                var $452 = {};
                                for (var $453 in v1) {
                                    if ({}.hasOwnProperty.call(v1, $453)) {
                                        $452[$453] = v1[$453];
                                    };
                                };
                                $452.cache = insert(cacheKey)(tournamentData.value0)(state.cache);
                                return $452;
                            })))(function () {
                                var response = {
                                    userId: v.value0.userId,
                                    tournamentId: v.value0.tournament.value0.tournamentId,
                                    isCurrentMatch: false,
                                    data: tournamentData.value0
                                };
                                return bind(get)(function (freshState) {
                                    if (freshState.broadcastManager instanceof Data_Maybe.Just) {
                                        return postTournamentDataResponse1(freshState.broadcastManager.value0)(response);
                                    };
                                    if (freshState.broadcastManager instanceof Data_Maybe.Nothing) {
                                        return liftEffect(Utils_Logger.log("[WorkerPage] ERROR: No broadcast manager available"));
                                    };
                                    throw new Error("Failed pattern match at Component.WorkerPage (line 265, column 13 - line 269, column 86): " + [ freshState.broadcastManager.constructor.name ]);
                                });
                            });
                        };
                        throw new Error("Failed pattern match at Component.WorkerPage (line 244, column 9 - line 269, column 86): " + [ tournamentData.constructor.name ]);
                    });
                });
            };
            throw new Error("Failed pattern match at Component.WorkerPage (line 160, column 5 - line 269, column 86): " + [ v.value0.tournament.constructor.name ]);
        };
        throw new Error("Failed pattern match at Component.WorkerPage (line 105, column 16 - line 269, column 86): " + [ v.constructor.name ]);
    };
};
var getStatusColor = function (state) {
    return Component_WorkerPageHelpers.getStatusColor(state.error)(state.status);
};
var render = function (state) {
    return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("position: fixed; top: 10px; left: 10px; z-index: 9999") ])([ Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; min-width: 300px") ])([ Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("font-weight: bold; margin-bottom: 5px") ])([ Halogen_HTML_Core.text("\ud83d\udd27 Tournament Worker Status") ]), Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("display: flex; align-items: center; gap: 10px; margin-bottom: 5px") ])([ Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("width: 10px; height: 10px; border-radius: 50%; background-color: " + getStatusColor(state)) ])([  ]), Halogen_HTML_Elements.span_([ Halogen_HTML_Core.text(state.status) ]) ]), Data_Maybe.fromMaybe(Halogen_HTML_Core.text(""))(mapFlipped1(state.error)(function (err) {
        return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("color: #ff4444; margin-bottom: 5px") ])([ Halogen_HTML_Core.text("\u274c " + err) ]);
    })), Halogen_HTML_Elements.div([ Halogen_HTML_Properties.style("font-size: 10px; color: #aaa; margin-top: 5px") ])([ Halogen_HTML_Core.text("Broadcasting on 'tournament-updates' & 'worker-status' channels") ]) ]) ]);
};
var component = function (dictMonadAff) {
    return Halogen_Component.mkComponent({
        initialState: initialState,
        render: render,
        "eval": Halogen_Component.mkEval({
            handleQuery: Halogen_Component.defaultEval.handleQuery,
            receive: Halogen_Component.defaultEval.receive,
            handleAction: handleAction(dictMonadAff),
            initialize: new Data_Maybe.Just(Initialize.value),
            finalize: new Data_Maybe.Just(Finalize.value)
        })
    });
};
export {
    makeCacheKey,
    Initialize,
    Finalize,
    UpdateStatus,
    HandleSubscribe,
    component,
    initialState,
    render,
    getStatusColor,
    handleAction
};
