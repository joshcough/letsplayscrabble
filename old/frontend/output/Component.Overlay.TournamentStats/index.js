// Generated by purs version 0.15.15
import * as BroadcastChannel_Class from "../BroadcastChannel.Class/index.js";
import * as BroadcastChannel_MonadBroadcast from "../BroadcastChannel.MonadBroadcast/index.js";
import * as BroadcastChannel_MonadEmitters from "../BroadcastChannel.MonadEmitters/index.js";
import * as CSS_Class from "../CSS.Class/index.js";
import * as CSS_ThemeColor from "../CSS.ThemeColor/index.js";
import * as Config_Themes from "../Config.Themes/index.js";
import * as Control_Alt from "../Control.Alt/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Halogen_Component from "../Halogen.Component/index.js";
import * as Halogen_HTML_Core from "../Halogen.HTML.Core/index.js";
import * as Halogen_HTML_Elements from "../Halogen.HTML.Elements/index.js";
import * as Halogen_Query_HalogenM from "../Halogen.Query.HalogenM/index.js";
import * as Halogen_Subscription from "../Halogen.Subscription/index.js";
import * as Stats_OverlayLogic from "../Stats.OverlayLogic/index.js";
import * as Stats_TournamentStats from "../Stats.TournamentStats/index.js";
import * as Utils_CSS from "../Utils.CSS/index.js";
import * as Utils_Format from "../Utils.Format/index.js";
import * as Utils_Logger from "../Utils.Logger/index.js";
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(Halogen_Query_HalogenM.monadStateHalogenM);
var over = /* #__PURE__ */ Data_Newtype.over()();
var alt = /* #__PURE__ */ Control_Alt.alt(Data_Maybe.altMaybe);
var bind = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var mapFlipped = /* #__PURE__ */ Data_Functor.mapFlipped(Data_Maybe.functorMaybe);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM);
var get = /* #__PURE__ */ Control_Monad_State_Class.get(Halogen_Query_HalogenM.monadStateHalogenM);
var $$void = /* #__PURE__ */ Data_Functor["void"](Halogen_Query_HalogenM.functorHalogenM);
var mapFlipped1 = /* #__PURE__ */ Data_Functor.mapFlipped(Halogen_Subscription.functorEmitter);
var when = /* #__PURE__ */ Control_Applicative.when(Halogen_Query_HalogenM.applicativeHalogenM);
var State = function (x) {
    return x;
};
var Initialize = /* #__PURE__ */ (function () {
    function Initialize() {

    };
    Initialize.value = new Initialize();
    return Initialize;
})();
var HandleTournamentData = /* #__PURE__ */ (function () {
    function HandleTournamentData(value0) {
        this.value0 = value0;
    };
    HandleTournamentData.create = function (value0) {
        return new HandleTournamentData(value0);
    };
    return HandleTournamentData;
})();
var HandleAdminPanelUpdate = /* #__PURE__ */ (function () {
    function HandleAdminPanelUpdate(value0) {
        this.value0 = value0;
    };
    HandleAdminPanelUpdate.create = function (value0) {
        return new HandleAdminPanelUpdate(value0);
    };
    return HandleAdminPanelUpdate;
})();
var Finalize = /* #__PURE__ */ (function () {
    function Finalize() {

    };
    Finalize.value = new Finalize();
    return Finalize;
})();
var renderStatItem = function (theme) {
    return function (label) {
        return function (value) {
            return function (icon) {
                return function (_colorGradient) {
                    return Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.thm(theme)(CSS_ThemeColor.CardBackground.value), Utils_CSS.cls(CSS_Class.Rounded_2xl.value), Utils_CSS.cls(CSS_Class.P_6.value), Utils_CSS.cls(CSS_Class.Border.value), Utils_CSS.thm(theme)(CSS_ThemeColor.PrimaryBorder.value), Utils_CSS.cls(CSS_Class.ShadowXl.value), Utils_CSS.raw("min-w-[180px]") ]) ])([ Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Flex.value), Utils_CSS.cls(CSS_Class.FlexCol.value), Utils_CSS.cls(CSS_Class.ItemsCenter.value) ]) ])([ Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Text_3xl.value), Utils_CSS.cls(CSS_Class.Mb_2.value) ]) ])([ Halogen_HTML_Core.text(icon) ]), Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.thm(theme)(CSS_ThemeColor.TextAccent.value), Utils_CSS.cls(CSS_Class.Text_Lg.value), Utils_CSS.cls(CSS_Class.FontBold.value), Utils_CSS.cls(CSS_Class.Uppercase.value), Utils_CSS.cls(CSS_Class.TrackingWider.value), Utils_CSS.cls(CSS_Class.Mb_3.value) ]) ])([ Halogen_HTML_Core.text(label) ]), Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Text_5xl.value), Utils_CSS.cls(CSS_Class.FontBlack.value), Utils_CSS.thm(theme)(CSS_ThemeColor.TextPrimary.value) ]) ])([ Halogen_HTML_Core.text(value) ]) ]) ]);
                };
            };
        };
    };
};
var renderLoading = /* #__PURE__ */ (function () {
    return Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Flex.value), Utils_CSS.cls(CSS_Class.ItemsCenter.value), Utils_CSS.cls(CSS_Class.JustifyCenter.value), Utils_CSS.cls(CSS_Class.HScreen.value) ]) ])([ Halogen_HTML_Core.text("Loading...") ]);
})();
var renderError = function (err) {
    return Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Flex.value), Utils_CSS.cls(CSS_Class.ItemsCenter.value), Utils_CSS.cls(CSS_Class.JustifyCenter.value), Utils_CSS.cls(CSS_Class.HScreen.value), Utils_CSS.cls(CSS_Class.TextRed600.value) ]) ])([ Halogen_HTML_Core.text("Error: " + err) ]);
};
var newtypeStateTournamentStats = {
    Coercible0: function () {
        return undefined;
    }
};
var renderStats = function (state) {
    return function (stats) {
        var s = unwrap(state);
        var titleGradient = Utils_CSS.raw(s.theme.titleExtraClasses + (" bg-gradient-to-r " + s.theme.colors.titleGradient));
        return Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.thm(s.theme)(CSS_ThemeColor.PageBackground.value), Utils_CSS.cls(CSS_Class.MinHScreen.value), Utils_CSS.cls(CSS_Class.Flex.value), Utils_CSS.cls(CSS_Class.ItemsCenter.value), Utils_CSS.cls(CSS_Class.JustifyCenter.value), Utils_CSS.cls(CSS_Class.P_6.value) ]) ])([ Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.MaxW_7xl.value), Utils_CSS.cls(CSS_Class.W_Full.value) ]) ])([ Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.TextCenter.value), Utils_CSS.cls(CSS_Class.Mb_16.value) ]) ])([ Halogen_HTML_Elements.h1([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Text_6xl.value), Utils_CSS.cls(CSS_Class.FontBlack.value), Utils_CSS.cls(CSS_Class.Mb_4.value), titleGradient ]) ])([ Halogen_HTML_Core.text("Tournament Statistics") ]), Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Text_3xl.value), Utils_CSS.thm(s.theme)(CSS_ThemeColor.TextSecondary.value) ]) ])([ Halogen_HTML_Core.text(s.title) ]) ]), Halogen_HTML_Elements.div([ Utils_CSS.css([ Utils_CSS.cls(CSS_Class.Flex.value), Utils_CSS.cls(CSS_Class.JustifyCenter.value), Utils_CSS.cls(CSS_Class.Gap_6.value), Utils_CSS.cls(CSS_Class.FlexWrap.value), Utils_CSS.cls(CSS_Class.Mt_8.value) ]) ])([ renderStatItem(s.theme)("Games Played")(show(stats.gamesPlayed))("\ud83c\udfae")("from-green-400 to-blue-500"), renderStatItem(s.theme)("Points Scored")(Utils_Format.formatWithCommas(stats.pointsScored))("\ud83d\udcaf")("from-yellow-400 to-orange-500"), renderStatItem(s.theme)("Average Score")(stats.averageScore)("\ud83d\udcca")("from-purple-400 to-pink-500"), renderStatItem(s.theme)("Higher Rated Win%")(Utils_Format.formatPercent(stats.higherRatedWinPercent))("\ud83c\udfc6")("from-blue-400 to-cyan-500"), renderStatItem(s.theme)("Going First Win%")(Utils_Format.formatPercent(stats.goingFirstWinPercent))("\ud83e\udd47")("from-red-400 to-pink-500") ]) ]) ]);
    };
};
var render = function (state) {
    var s = unwrap(state);
    if (s.loading) {
        return renderLoading;
    };
    if (s.error instanceof Data_Maybe.Just) {
        return renderError(s.error.value0);
    };
    if (s.error instanceof Data_Maybe.Nothing) {
        if (s.stats instanceof Data_Maybe.Just) {
            return renderStats(state)(s.stats.value0);
        };
        if (s.stats instanceof Data_Maybe.Nothing) {
            return renderError("No tournament data");
        };
        throw new Error("Failed pattern match at Component.Overlay.TournamentStats (line 94, column 16 - line 96, column 50): " + [ s.stats.constructor.name ]);
    };
    throw new Error("Failed pattern match at Component.Overlay.TournamentStats (line 92, column 8 - line 96, column 50): " + [ s.error.constructor.name ]);
};
var resolveDivisionName = function (state) {
    var s = unwrap(state);
    if (s.subscribedToCurrentMatch) {
        return s.currentMatchDivisionName;
    };
    if (s.input.subscription instanceof Stats_OverlayLogic.SpecificTournament) {
        return new Data_Maybe.Just(s.input.subscription.value0.divisionName);
    };
    return Data_Maybe.Nothing.value;
};
var updateStateWithError = function (dictMonadAff) {
    return discard(Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0()))(Utils_Logger.log("[TournamentStats] ERROR: Could not calculate stats")))(function () {
        return modify_(over(State)(function (v) {
            return {
                currentMatchDivisionName: v.currentMatchDivisionName,
                input: v.input,
                stats: v.stats,
                subscribedToCurrentMatch: v.subscribedToCurrentMatch,
                theme: v.theme,
                title: v.title,
                tournamentName: v.tournamentName,
                error: new Data_Maybe.Just("Could not calculate tournament stats"),
                loading: false
            };
        }));
    });
};
var updateStateWithStats = function (statsResult) {
    return function (tournamentName) {
        return function (title) {
            return function (theme) {
                return modify_(over(State)(function (v) {
                    return {
                        currentMatchDivisionName: v.currentMatchDivisionName,
                        input: v.input,
                        subscribedToCurrentMatch: v.subscribedToCurrentMatch,
                        stats: new Data_Maybe.Just(statsResult),
                        tournamentName: tournamentName,
                        title: title,
                        theme: theme,
                        loading: false,
                        error: Data_Maybe.Nothing.value
                    };
                }));
            };
        };
    };
};
var initialState = function (input) {
    return {
        input: input,
        stats: Data_Maybe.Nothing.value,
        tournamentName: "",
        title: "",
        loading: true,
        error: Data_Maybe.Nothing.value,
        theme: Config_Themes.getTheme("scrabble"),
        subscribedToCurrentMatch: (function () {
            if (input.subscription instanceof Stats_OverlayLogic.CurrentMatch) {
                return true;
            };
            return false;
        })(),
        currentMatchDivisionName: Data_Maybe.Nothing.value
    };
};
var calculateStatsForDivision = function (response) {
    return function (divisionName) {
        return alt(bind(divisionName)(function (divName) {
            return mapFlipped(Data_Array.find(function (d) {
                return d.name === divName;
            })(response.data.divisions))(function (div) {
                return Stats_TournamentStats.calculateTournamentStats(div.games)(div.players);
            });
        }))(new Data_Maybe.Just(Stats_TournamentStats.calculateAllTournamentStats(response.data)));
    };
};
var buildTitleForStats = function (tournamentName) {
    return function (divisionName) {
        return Data_Maybe.maybe(tournamentName + " - Total Tournament Stats")(function (divName) {
            return tournamentName + (" Div " + (divName + " - Total Tournament Stats"));
        })(divisionName);
    };
};
var handleAction = function (dictMonadAff) {
    var monadAffHalogenM = Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff);
    var subscribeTournamentData = BroadcastChannel_MonadEmitters.subscribeTournamentData(monadAffHalogenM);
    var subscribeAdminPanel = BroadcastChannel_MonadEmitters.subscribeAdminPanel(monadAffHalogenM);
    var postSubscribe = BroadcastChannel_Class.postSubscribe(monadAffHalogenM);
    var updateStateWithError1 = updateStateWithError(dictMonadAff);
    var closeBroadcast = BroadcastChannel_Class.closeBroadcast(monadAffHalogenM);
    return function (dictMonadBroadcast) {
        var monadBroadcastHalogenM = BroadcastChannel_MonadBroadcast.monadBroadcastHalogenM(dictMonadBroadcast);
        var postSubscribe1 = postSubscribe(monadBroadcastHalogenM);
        var closeBroadcast1 = closeBroadcast(monadBroadcastHalogenM);
        return function (dictMonadEmitters) {
            var monadEmittersHalogenM = BroadcastChannel_MonadEmitters.monadEmittersHalogenM(dictMonadEmitters);
            var subscribeTournamentData1 = subscribeTournamentData(monadEmittersHalogenM);
            var subscribeAdminPanel1 = subscribeAdminPanel(monadEmittersHalogenM);
            return function (v) {
                if (v instanceof Initialize) {
                    return bind1(get)(function (state) {
                        var input = (unwrap(state)).input;
                        return bind1(subscribeTournamentData1)(function (tournamentDataEmitter) {
                            return discard($$void(Halogen_Query_HalogenM.subscribe(mapFlipped1(tournamentDataEmitter)(HandleTournamentData.create))))(function () {
                                return bind1(subscribeAdminPanel1)(function (adminPanelEmitter) {
                                    return discard($$void(Halogen_Query_HalogenM.subscribe(mapFlipped1(adminPanelEmitter)(HandleAdminPanelUpdate.create))))(function () {
                                        return postSubscribe1(Stats_OverlayLogic.buildSubscribeMessage(input.userId)(input.subscription));
                                    });
                                });
                            });
                        });
                    });
                };
                if (v instanceof HandleTournamentData) {
                    return bind1(get)(function (state) {
                        var theme = Config_Themes.getTheme(v.value0.data.theme);
                        var divisionName = resolveDivisionName(state);
                        var stats = calculateStatsForDivision(v.value0)(divisionName);
                        var title = buildTitleForStats(v.value0.data.name)(divisionName);
                        return Data_Maybe.maybe(updateStateWithError1)(function (statsResult) {
                            return updateStateWithStats(statsResult)(v.value0.data.name)(title)(theme);
                        })(stats);
                    });
                };
                if (v instanceof HandleAdminPanelUpdate) {
                    return bind1(get)(function (state) {
                        var s = unwrap(state);
                        return when(s.subscribedToCurrentMatch)(modify_(over(State)(function (v1) {
                            return {
                                error: v1.error,
                                input: v1.input,
                                loading: v1.loading,
                                stats: v1.stats,
                                subscribedToCurrentMatch: v1.subscribedToCurrentMatch,
                                theme: v1.theme,
                                title: v1.title,
                                tournamentName: v1.tournamentName,
                                currentMatchDivisionName: new Data_Maybe.Just(v.value0.divisionName)
                            };
                        })));
                    });
                };
                if (v instanceof Finalize) {
                    return closeBroadcast1;
                };
                throw new Error("Failed pattern match at Component.Overlay.TournamentStats (line 213, column 16 - line 250, column 19): " + [ v.constructor.name ]);
            };
        };
    };
};
var component = function (dictMonadAff) {
    var handleAction1 = handleAction(dictMonadAff);
    return function (dictMonadBroadcast) {
        var handleAction2 = handleAction1(dictMonadBroadcast);
        return function (dictMonadEmitters) {
            return Halogen_Component.mkComponent({
                initialState: initialState,
                render: render,
                "eval": Halogen_Component.mkEval({
                    handleQuery: Halogen_Component.defaultEval.handleQuery,
                    receive: Halogen_Component.defaultEval.receive,
                    handleAction: handleAction2(dictMonadEmitters),
                    initialize: new Data_Maybe.Just(Initialize.value),
                    finalize: new Data_Maybe.Just(Finalize.value)
                })
            });
        };
    };
};
export {
    State,
    Initialize,
    HandleTournamentData,
    HandleAdminPanelUpdate,
    Finalize,
    component,
    initialState,
    render,
    renderLoading,
    renderError,
    renderStats,
    renderStatItem,
    resolveDivisionName,
    calculateStatsForDivision,
    buildTitleForStats,
    updateStateWithStats,
    updateStateWithError,
    handleAction,
    newtypeStateTournamentStats
};
