// Generated by purs version 0.15.15
import * as BroadcastChannel from "../BroadcastChannel/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Argonaut_Core from "../Data.Argonaut.Core/index.js";
import * as Data_Argonaut_Encode_Class from "../Data.Argonaut.Encode.Class/index.js";
import * as Data_Argonaut_Encode_Combinators from "../Data.Argonaut.Encode.Combinators/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Foreign from "../Foreign/index.js";
import * as SocketIO from "../SocketIO/index.js";
import * as Utils_Logger from "../Utils.Logger/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var for_ = /* #__PURE__ */ Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe);
var extend = /* #__PURE__ */ Data_Argonaut_Encode_Combinators.extend(Data_Argonaut_Encode_Class.encodeJsonJson);
var assoc = /* #__PURE__ */ Data_Argonaut_Encode_Combinators.assoc(Data_Argonaut_Encode_Class.encodeJsonJString);
var assoc1 = /* #__PURE__ */ Data_Argonaut_Encode_Combinators.assoc(Data_Argonaut_Encode_Class.encodeJsonJson);
var logInfo = function (msg) {
    return Utils_Logger.log("[WorkerSocketManager] " + msg);
};
var createWorkerState = function __do() {
    var bc = BroadcastChannel.create("tournament-updates")();
    var sc = BroadcastChannel.create("worker-status")();
    return {
        socket: Data_Maybe.Nothing.value,
        broadcastChannel: bc,
        statusChannel: sc,
        connectionStatus: "Initializing...",
        error: Data_Maybe.Nothing.value,
        lastDataUpdate: 0.0
    };
};
var cleanup = function (stateRef) {
    return function __do() {
        var state = Effect_Ref.read(stateRef)();
        for_(state.socket)(SocketIO.disconnect)();
        BroadcastChannel.close(state.broadcastChannel)();
        BroadcastChannel.close(state.statusChannel)();
        return Data_Unit.unit;
    };
};
var broadcastStatus = function (stateRef) {
    return function __do() {
        var state = Effect_Ref.read(stateRef)();
        var statusMsg = {
            type: "WORKER_STATUS_UPDATE",
            data: {
                status: state.connectionStatus,
                error: state.error,
                lastDataUpdate: state.lastDataUpdate,
                cacheStats: {
                    size: 0,
                    keys: [  ]
                }
            }
        };
        BroadcastChannel.postMessage(state.statusChannel)(Foreign.unsafeToForeign(statusMsg))();
        return Data_Unit.unit;
    };
};
var initialize = function (apiUrl) {
    return function (stateRef) {
        var handlePing = function (v) {
            return pure(Data_Unit.unit);
        };
        var handleGamesAdded = function (foreignData) {
            return function __do() {
                var state = Effect_Ref.read(stateRef)();
                var json = Foreign.unsafeFromForeign(foreignData);
                BroadcastChannel.postMessage(state.broadcastChannel)(Foreign.unsafeToForeign(json))();
                var currentState = Effect_Ref.read(stateRef)();
                Effect_Ref.write({
                    broadcastChannel: currentState.broadcastChannel,
                    connectionStatus: currentState.connectionStatus,
                    error: currentState.error,
                    socket: currentState.socket,
                    statusChannel: currentState.statusChannel,
                    lastDataUpdate: 0.0
                })(stateRef)();
                return Data_Unit.unit;
            };
        };
        var handleAdminPanelUpdate = function (foreignData) {
            return function __do() {
                var state = Effect_Ref.read(stateRef)();
                var json = Foreign.unsafeFromForeign(foreignData);
                var wrappedMessage = extend(assoc("type")("ADMIN_PANEL_UPDATE"))(extend(assoc1("data")(json))(Data_Argonaut_Core.jsonEmptyObject));
                BroadcastChannel.postMessage(state.broadcastChannel)(Foreign.unsafeToForeign(wrappedMessage))();
                return Data_Unit.unit;
            };
        };
        return function __do() {
            logInfo("Connecting to Socket.IO at: " + apiUrl)();
            var socket = SocketIO.connect(apiUrl)(SocketIO.defaultOptions)();
            var state = Effect_Ref.read(stateRef)();
            Effect_Ref.write({
                broadcastChannel: state.broadcastChannel,
                connectionStatus: state.connectionStatus,
                error: state.error,
                lastDataUpdate: state.lastDataUpdate,
                statusChannel: state.statusChannel,
                socket: new Data_Maybe.Just(socket)
            })(stateRef)();
            logInfo("Socket.IO connection initiated")();
            SocketIO.on(socket)("connect")(function (v) {
                return function __do() {
                    logInfo("Socket.IO connected!")();
                    var currentState = Effect_Ref.read(stateRef)();
                    Effect_Ref.write({
                        broadcastChannel: currentState.broadcastChannel,
                        lastDataUpdate: currentState.lastDataUpdate,
                        socket: currentState.socket,
                        statusChannel: currentState.statusChannel,
                        connectionStatus: "Connected",
                        error: Data_Maybe.Nothing.value
                    })(stateRef)();
                    return broadcastStatus(stateRef)();
                };
            })();
            SocketIO.on(socket)("connect_error")(function (v) {
                return function __do() {
                    logInfo("Socket.IO connection error")();
                    var currentState = Effect_Ref.read(stateRef)();
                    Effect_Ref.write({
                        broadcastChannel: currentState.broadcastChannel,
                        lastDataUpdate: currentState.lastDataUpdate,
                        socket: currentState.socket,
                        statusChannel: currentState.statusChannel,
                        connectionStatus: "Connection Error",
                        error: new Data_Maybe.Just("Failed to connect")
                    })(stateRef)();
                    return broadcastStatus(stateRef)();
                };
            })();
            SocketIO.on(socket)("disconnect")(function (v) {
                return function __do() {
                    logInfo("Socket.IO disconnected")();
                    var currentState = Effect_Ref.read(stateRef)();
                    Effect_Ref.write({
                        broadcastChannel: currentState.broadcastChannel,
                        error: currentState.error,
                        lastDataUpdate: currentState.lastDataUpdate,
                        socket: currentState.socket,
                        statusChannel: currentState.statusChannel,
                        connectionStatus: "Disconnected"
                    })(stateRef)();
                    return broadcastStatus(stateRef)();
                };
            })();
            SocketIO.on(socket)("GamesAdded")(handleGamesAdded)();
            SocketIO.on(socket)("admin-panel-update")(handleAdminPanelUpdate)();
            SocketIO.on(socket)("Ping")(handlePing)();
            return Data_Unit.unit;
        };
    };
};
export {
    logInfo,
    createWorkerState,
    initialize,
    broadcastStatus,
    cleanup
};
