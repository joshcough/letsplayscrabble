// Generated by purs version 0.15.15
import * as BroadcastChannel_Manager from "../BroadcastChannel.Manager/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Domain_Types from "../Domain.Types/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
import * as Halogen_Component from "../Halogen.Component/index.js";
import * as Halogen_HTML_Core from "../Halogen.HTML.Core/index.js";
import * as Halogen_HTML_Elements from "../Halogen.HTML.Elements/index.js";
import * as Halogen_HTML_Properties from "../Halogen.HTML.Properties/index.js";
import * as Halogen_Query_HalogenM from "../Halogen.Query.HalogenM/index.js";
import * as Halogen_Subscription from "../Halogen.Subscription/index.js";
import * as Stats_PlayerStats from "../Stats.PlayerStats/index.js";
import * as Types_Theme from "../Types.Theme/index.js";
import * as Utils_FormatUtils from "../Utils.FormatUtils/index.js";
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM);
var bind = /* #__PURE__ */ Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM);
var get = /* #__PURE__ */ Control_Monad_State_Class.get(Halogen_Query_HalogenM.monadStateHalogenM);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(Halogen_Query_HalogenM.monadStateHalogenM);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var show1 = /* #__PURE__ */ Data_Show.show(Domain_Types.showTournamentId);
var show2 = /* #__PURE__ */ Data_Show.show(/* #__PURE__ */ Data_Maybe.showMaybe(Domain_Types.showDivisionId));
var $$void = /* #__PURE__ */ Data_Functor["void"](Halogen_Query_HalogenM.functorHalogenM);
var mapFlipped = /* #__PURE__ */ Data_Functor.mapFlipped(Halogen_Subscription.functorEmitter);
var postSubscribe = /* #__PURE__ */ BroadcastChannel_Manager.postSubscribe(Effect_Class.monadEffectEffect);
var pure = /* #__PURE__ */ Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var Initialize = /* #__PURE__ */ (function () {
    function Initialize() {

    };
    Initialize.value = new Initialize();
    return Initialize;
})();
var HandleTournamentData = /* #__PURE__ */ (function () {
    function HandleTournamentData(value0) {
        this.value0 = value0;
    };
    HandleTournamentData.create = function (value0) {
        return new HandleTournamentData(value0);
    };
    return HandleTournamentData;
})();
var Finalize = /* #__PURE__ */ (function () {
    function Finalize() {

    };
    Finalize.value = new Finalize();
    return Finalize;
})();
var renderTableHeader = /* #__PURE__ */ Halogen_HTML_Elements.thead_([ /* #__PURE__ */ Halogen_HTML_Elements.tr_([ /* #__PURE__ */ Halogen_HTML_Elements.th([ /* #__PURE__ */ Halogen_HTML_Properties.class_("border p-2 text-left") ])([ /* #__PURE__ */ Halogen_HTML_Core.text("Rank") ]), /* #__PURE__ */ Halogen_HTML_Elements.th([ /* #__PURE__ */ Halogen_HTML_Properties.class_("border p-2 text-left") ])([ /* #__PURE__ */ Halogen_HTML_Core.text("Name") ]), /* #__PURE__ */ Halogen_HTML_Elements.th([ /* #__PURE__ */ Halogen_HTML_Properties.class_("border p-2 text-left") ])([ /* #__PURE__ */ Halogen_HTML_Core.text("Record") ]), /* #__PURE__ */ Halogen_HTML_Elements.th([ /* #__PURE__ */ Halogen_HTML_Properties.class_("border p-2 text-left") ])([ /* #__PURE__ */ Halogen_HTML_Core.text("Spread") ]) ]) ]);
var renderLoading = /* #__PURE__ */ Halogen_HTML_Elements.div([ /* #__PURE__ */ Halogen_HTML_Properties.class_("flex items-center justify-center h-screen") ])([ /* #__PURE__ */ Halogen_HTML_Core.text("Loading standings...") ]);
var renderError = function (err) {
    return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.class_("flex items-center justify-center h-screen text-red-600") ])([ Halogen_HTML_Core.text("Error: " + err) ]);
};
var initialState = function (input) {
    return {
        manager: Data_Maybe.Nothing.value,
        tournament: Data_Maybe.Nothing.value,
        players: [  ],
        divisionName: "",
        loading: true,
        error: Data_Maybe.Nothing.value,
        theme: Types_Theme.defaultTheme,
        input: new Data_Maybe.Just(input)
    };
};
var handleAction = function (dictMonadAff) {
    var monadEffectHalogenM = Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0());
    var liftEffect = Effect_Class.liftEffect(monadEffectHalogenM);
    var close = BroadcastChannel_Manager.close(monadEffectHalogenM);
    return function (v) {
        if (v instanceof Initialize) {
            return discard(liftEffect(Effect_Console.log("[Standings] Initialize called")))(function () {
                return bind(get)(function (state) {
                    if (state.input instanceof Data_Maybe.Nothing) {
                        return discard(liftEffect(Effect_Console.log("[Standings] ERROR: No input found in state")))(function () {
                            return modify_(function (v1) {
                                var $32 = {};
                                for (var $33 in v1) {
                                    if ({}.hasOwnProperty.call(v1, $33)) {
                                        $32[$33] = v1[$33];
                                    };
                                };
                                $32.error = new Data_Maybe.Just("No tournament parameters provided");
                                $32.loading = false;
                                return $32;
                            });
                        });
                    };
                    if (state.input instanceof Data_Maybe.Just) {
                        return discard(liftEffect(Effect_Console.log("[Standings] Input: userId=" + (show(state.input.value0.userId) + (", tournamentId=" + (show1(state.input.value0.tournamentId) + (", divisionId=" + show2(state.input.value0.divisionId))))))))(function () {
                            return discard(liftEffect(Effect_Console.log("[Standings] Creating broadcast manager")))(function () {
                                return bind(liftEffect(BroadcastChannel_Manager.create))(function (manager) {
                                    return discard(liftEffect(Effect_Console.log("[Standings] Subscribing to tournament data responses")))(function () {
                                        return discard($$void(Halogen_Query_HalogenM.subscribe(mapFlipped(manager.tournamentDataResponseEmitter)(HandleTournamentData.create))))(function () {
                                            return discard(modify_(function (v1) {
                                                var $35 = {};
                                                for (var $36 in v1) {
                                                    if ({}.hasOwnProperty.call(v1, $36)) {
                                                        $35[$36] = v1[$36];
                                                    };
                                                };
                                                $35.manager = new Data_Maybe.Just(manager);
                                                return $35;
                                            }))(function () {
                                                var subscribeMsg = {
                                                    userId: state.input.value0.userId,
                                                    tournamentId: state.input.value0.tournamentId,
                                                    divisionId: state.input.value0.divisionId,
                                                    divisionName: state.input.value0.divisionName
                                                };
                                                return discard(liftEffect(Effect_Console.log("[Standings] Sending subscribe message for tournament " + show(state.input.value0.tournamentId))))(function () {
                                                    return discard(liftEffect(postSubscribe(manager)(subscribeMsg)))(function () {
                                                        return liftEffect(Effect_Console.log("[Standings] Subscribe message sent"));
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    };
                    throw new Error("Failed pattern match at Component.Standings (line 185, column 5 - line 220, column 70): " + [ state.input.constructor.name ]);
                });
            });
        };
        if (v instanceof HandleTournamentData) {
            return discard(liftEffect(Effect_Console.log("[Standings] Received tournament data response")))(function () {
                return discard(liftEffect(Effect_Console.log("[Standings] Division: " + v.value0.data.division.name)))(function () {
                    return discard(liftEffect(Effect_Console.log("[Standings] Players count: " + show(Data_Array.length(v.value0.data.division.players)))))(function () {
                        return discard(liftEffect(Effect_Console.log("[Standings] Games count: " + show(Data_Array.length(v.value0.data.division.games)))))(function () {
                            var players = Stats_PlayerStats.calculateRankedStats(Stats_PlayerStats.Standings.value)(v.value0.data.division.players)(v.value0.data.division.games);
                            return discard(liftEffect(Effect_Console.log("[Standings] Calculated " + (show(Data_Array.length(players)) + " ranked players"))))(function () {
                                return discard(modify_(function (v1) {
                                    var $40 = {};
                                    for (var $41 in v1) {
                                        if ({}.hasOwnProperty.call(v1, $41)) {
                                            $40[$41] = v1[$41];
                                        };
                                    };
                                    $40.tournament = new Data_Maybe.Just(v.value0.data);
                                    $40.players = players;
                                    $40.divisionName = v.value0.data.division.name;
                                    $40.loading = false;
                                    $40.error = Data_Maybe.Nothing.value;
                                    return $40;
                                }))(function () {
                                    return liftEffect(Effect_Console.log("[Standings] State updated with tournament data"));
                                });
                            });
                        });
                    });
                });
            });
        };
        if (v instanceof Finalize) {
            return bind(get)(function (state) {
                if (state.manager instanceof Data_Maybe.Just) {
                    return close(state.manager.value0);
                };
                if (state.manager instanceof Data_Maybe.Nothing) {
                    return pure(Data_Unit.unit);
                };
                throw new Error("Failed pattern match at Component.Standings (line 251, column 5 - line 253, column 27): " + [ state.manager.constructor.name ]);
            });
        };
        throw new Error("Failed pattern match at Component.Standings (line 179, column 16 - line 253, column 27): " + [ v.constructor.name ]);
    };
};
var getSpreadColor = function (theme) {
    return function (spread) {
        if (spread > 0) {
            return "text-red-600";
        };
        if (spread < 0) {
            return "text-blue-600";
        };
        if (Data_Boolean.otherwise) {
            return theme.colors.textPrimary;
        };
        throw new Error("Failed pattern match at Component.Standings (line 171, column 1 - line 171, column 41): " + [ theme.constructor.name, spread.constructor.name ]);
    };
};
var formatRecord = function (player) {
    var $48 = player.ties === 0;
    if ($48) {
        return show(player.wins) + ("-" + show(player.losses));
    };
    return show(player.wins) + ("-" + (show(player.losses) + ("-" + show(player.ties))));
};
var renderPlayerRow = function (theme) {
    return function (player) {
        return Halogen_HTML_Elements.tr_([ Halogen_HTML_Elements.td([ Halogen_HTML_Properties.class_("border p-2") ])([ Halogen_HTML_Elements.span([ Halogen_HTML_Properties.class_("text-2xl font-black") ])([ Halogen_HTML_Core.text("#" + show(player.rank)) ]) ]), Halogen_HTML_Elements.td([ Halogen_HTML_Properties.class_("border p-2") ])([ Halogen_HTML_Core.text(player.name) ]), Halogen_HTML_Elements.td([ Halogen_HTML_Properties.class_("border p-2") ])([ Halogen_HTML_Elements.span([ Halogen_HTML_Properties.class_("font-mono font-black text-2xl") ])([ Halogen_HTML_Core.text(formatRecord(player)) ]) ]), Halogen_HTML_Elements.td([ Halogen_HTML_Properties.class_("border p-2") ])([ Halogen_HTML_Elements.span([ Halogen_HTML_Properties.class_("font-black text-2xl " + getSpreadColor(theme)(player.spread)) ])([ Halogen_HTML_Core.text(Utils_FormatUtils.formatNumberWithSign(player.spread)) ]) ]) ]);
    };
};
var renderStandings = function (state) {
    return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.class_("container mx-auto p-4") ])([ Halogen_HTML_Elements.h1([ Halogen_HTML_Properties.class_("text-4xl font-bold mb-4") ])([ Halogen_HTML_Core.text("Standings - " + state.divisionName) ]), Halogen_HTML_Elements.table([ Halogen_HTML_Properties.class_("w-full border-collapse") ])([ renderTableHeader, Halogen_HTML_Elements.tbody_(map(renderPlayerRow(state.theme))(state.players)) ]) ]);
};
var render = function (state) {
    return Halogen_HTML_Elements.div([ Halogen_HTML_Properties.class_("standings-overlay") ])([ (function () {
        if (state.loading) {
            return renderLoading;
        };
        if (state.error instanceof Data_Maybe.Just) {
            return renderError(state.error.value0);
        };
        if (state.error instanceof Data_Maybe.Nothing) {
            return renderStandings(state);
        };
        throw new Error("Failed pattern match at Component.Standings (line 81, column 12 - line 83, column 41): " + [ state.error.constructor.name ]);
    })() ]);
};
var component = function (dictMonadAff) {
    return Halogen_Component.mkComponent({
        initialState: initialState,
        render: render,
        "eval": Halogen_Component.mkEval({
            handleQuery: Halogen_Component.defaultEval.handleQuery,
            receive: Halogen_Component.defaultEval.receive,
            handleAction: handleAction(dictMonadAff),
            initialize: new Data_Maybe.Just(Initialize.value),
            finalize: new Data_Maybe.Just(Finalize.value)
        })
    });
};
export {
    Initialize,
    HandleTournamentData,
    Finalize,
    component,
    initialState,
    render,
    renderLoading,
    renderError,
    renderStandings,
    renderTableHeader,
    renderPlayerRow,
    formatRecord,
    getSpreadColor,
    handleAction
};
