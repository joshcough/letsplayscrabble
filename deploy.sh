#!/bin/bash
set -e  # Exit on any error

echo "ğŸš€ Full Stack Deployment Script"
echo "================================="
echo ""

# Check we're in the right directory (root)
if [ ! -f "package.json" ] || [ ! -d "frontend" ] || [ ! -d "backend" ]; then
  echo "âŒ Error: Must run from project root directory"
  exit 1
fi

# Build the frontend
echo "ğŸ“¦ Building PureScript frontend..."
cd frontend
make build
cd ..

# Check if built files exist
if [ ! -f "frontend/public/bundle.js" ]; then
  echo "âŒ Error: bundle.js not generated"
  exit 1
fi

if [ ! -f "frontend/public/styles.css" ]; then
  echo "âŒ Error: styles.css not generated"
  exit 1
fi

echo "âœ… Frontend build complete"
echo ""

# Show bundle size
BUNDLE_SIZE=$(du -h frontend/public/bundle.js | cut -f1)
CSS_SIZE=$(du -h frontend/public/styles.css | cut -f1)
echo "ğŸ“Š Bundle size: $BUNDLE_SIZE"
echo "ğŸ“Š CSS size: $CSS_SIZE"
echo ""

# Add built files to git
echo "ğŸ“ Staging built frontend files..."
git add frontend/public/bundle.js frontend/public/styles.css

# Check if there are changes to commit
if git diff --cached --quiet; then
  echo "â„¹ï¸  No changes to built files, skipping commit"
else
  echo "ğŸ’¾ Committing built files..."
  git commit -m "Build PureScript frontend for deployment

Bundle: $BUNDLE_SIZE
CSS: $CSS_SIZE

ğŸ¤– Generated by deploy.sh"
fi

echo ""
echo "ğŸ¯ Ready to deploy!"
echo ""
echo "Next steps:"
echo "  1. Push to your branch: git push origin $(git branch --show-current)"
echo "  2. Deploy to Heroku: git push heroku $(git branch --show-current):master"
echo ""
echo "Heroku will build both frontend and backend on deployment."
echo ""
echo "Or run this now:"
echo "  git push heroku $(git branch --show-current):master"
echo ""

read -p "Deploy to Heroku now? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo "ğŸš€ Deploying to Heroku..."
  git push heroku $(git branch --show-current):master

  echo ""
  echo "âœ… Deployment complete!"
  echo "ğŸ“± Opening app..."
  heroku open
else
  echo "ğŸ‘ Skipping Heroku deploy"
fi
